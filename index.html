<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Motor Emulator</title>
    <style>
        #track { position: relative; width: 800px; margin: 20px auto; }
        #schiene { width: 100%; }
        #tape { position: absolute; bottom: -20px; left: 0; width: 114%; }
        #schlitten { position: absolute; bottom: 0; left: 0; width: 100px; transition: left 0.3s linear; }
        pre { background:#f0f0f0; padding:10px; width: 800px; margin:20px auto; }
    </style>
</head>
<body>
    <div id="track">
        <img id="schiene" src="schiene.png" alt="track" />
        <img id="tape" src="tape-md.png" alt="tape" />
        <img id="schlitten" src="schlitten.png" alt="sled" />
    </div>
    <pre id="status"></pre>
    <button id="emergencyBtn" style="display:block;margin:20px auto;">Emergency Stop</button>
    <div id="clients" style="width: 800px; margin: 20px auto; font-family: monospace;"></div>
    <script>
    function renderClients(list) {
        let html = '<table style="width:100%;border-collapse:collapse;"><tr><th>Type</th><th>Address</th><th>Status</th><th>Last seen</th></tr>';
        for (let c of list) {
            let color = c.status === 'online' ? '#b4f8c8' : '#ffb3b3';
            html += `<tr style="background:${color};">
                <td>${c.type}</td>
                <td>${c.address}</td>
                <td>${c.status}</td>
                <td>${Math.round((Date.now()/1000 - c.last_seen))}s ago</td>
            </tr>`;
        }
        html += '</table>';
        document.getElementById('clients').innerHTML = html;
    }

    setInterval(()=>{
        fetch('/clients').then(x=>x.json()).then(renderClients);
    }, 1000);
    </script>

    <script>
        const evt = new EventSource('/events');
        evt.onmessage = function(e) {
            const data = JSON.parse(e.data);
            document.getElementById('status').textContent = JSON.stringify(data, null, 2);
            const track = document.getElementById('track');
            const sled = document.getElementById('schlitten');
            const max = 100000; // expected range of position
            const trackWidth = track.clientWidth - sled.clientWidth;
            const pos = Math.max(0, Math.min(trackWidth, (data.position / max) * trackWidth));
            sled.style.left = pos + 'px';
        };

        // Emergency Stop button handler
        document.getElementById('emergencyBtn').onclick = function() {
            fetch('/emergency', { method: 'POST' });
        };
    </script>
</body>
</html>